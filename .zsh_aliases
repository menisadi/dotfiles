# Used third-party tools:
# - eza
# - lazygit
# - lazydocker
# - neofetch
# - glow
# - trafilatura
# - newsboat
# - csvlens
# - gping
# - timewarrior
# - spotify_player
# - git-graph
# - mods
# - yazi
# - ffmpeg
# - bat
# - gum
# - jq

# Used tools by me:
# - bejw
# - vibemark

# Used scripts by me:
# - move_csv.sh
# - ask.sh
# - since.sh
# - pomo.py
# - tw_pom.sh
# - graphfold.py
# - git_compress.py
# - list_erros.py
# - list_missing_docstrings.py
# - logic_map.py
# - search_unused_files.py
# - nowplaying.sh
# - pgn_analyze.py

alias lzg='lazygit'
alias lzd='lazydocker'
alias dclean="docker stop \$(docker ps -aq) && docker rm \$(docker ps -aq) && docker rmi \$(docker images -q)"

alias ee='eza --sort=created --icons=auto --group-directories-first'
alias el='eza -Xl --sort=created --icons=auto --group-directories-first --git --git-repos'
alias es='eza --sort=extension --icons=auto --group-directories-first'
alias esa='eza -Xa --sort=extension --icons=auto --group-directories-first'
alias eea='eza -Xa --sort=created --icons=auto --group-directories-first'
alias e5='eza --sort=modified -r --icons=always --color=always | head -5'
alias el5='eza -l --sort=modified -r --icons=always --color=always | head -5'
alias e10='eza --sort=modified -r --icons=always --color=always | head -10'
alias el10='eza -l --sort=modified -r --icons=always --color=always | head -10'

alias avim='NVIM_APPNAME=astronvim nvim'
alias kvim='NVIM_APPNAME=kickstart nvim'
alias lvim='NVIM_APPNAME=lazyvim nvim'
alias mvim='NVIM_APPNAME=minvim bob run nightly'
alias nvide='neovide'
alias avide='NVIM_APPNAME=astronvim neovide'

alias nvims='NVIM_APPNAME=$(find ~/.config -maxdepth 2 -type f -name "init.lua" -exec dirname {} \; | xargs -I {} basename {} | gum choose) nvim'

alias sysinfo='neofetch'
alias systeminfo='neofetch'
alias igrep="fzf --bind 'change:reload:rg --column --line-number --no-heading --color=always --smart-case {q} || true' --ansi --layout=reverse --header 'Search in files' --delimiter : --preview 'bat --color=always {1} --highlight-line {2}' --preview-window 'up,60%,border-bottom,+{2}+3/3,~3'"

alias tw='timew'
alias twt='timew start'
alias twc='timew continue'
alias twp='timew stop'
alias twm='timew summary sunday - eod'

twg() {
  local tags
  tags=$(
    timew tags | tail -n +4 | awk '{print $1}' |
    gum filter --no-limit |
    tr '\n' ' '
  )

  [[ -z "${tags//[[:space:]]/}" ]] && return 0

  timew start ${=tags}
}

alias nwb='newsboat'
alias cless='csvlens --color-columns'

alias mod='mods --role short --no-cache'
alias modn='mods --no-cache'
wcurl () { trafilatura -u "$1" --output-format txt 2>/dev/null | wc -w; }

bjc() {
  local url
  url=$(bejw list --format jsonl --no-header | jq -r '.url' | gum choose)
  if [[ -n "$url" ]]; then
    trafilatura --markdown -u "$url" | glow -p
  else
    echo "No URL selected."
  fi
}

bj() {
  local url
  url=$(bejw list --format csv | gum table | awk -F',' '{print $NF}')
  if [[ -n "$url" ]]; then
    trafilatura --markdown -u "$url" | glow -p
  else
    echo "No URL selected."
  fi
}

alias gpng='gping 1.1.1.1 8.8.8.8 -c red,green --clear'

alias pgc="ping -i 1 google.com | awk -F'time=' '{ if (\$2 ~ /ms/) { split(\$2, a, \" ms\"); time=a[1]; if (time < 50) printf \"\033[32mGood \033[0m\"; else if (time < 100) printf \"\033[33mFair \033[0m\"; else if (time < 200) printf \"\033[38;5;208mBad \033[0m\"; else printf \"\033[31mFail \033[0m\"; } else printf \"\033[31mFail \033[0m\"; fflush(); }'"

pgb() {
  local host="${1:-google.com}" # usage: pgb [host] [interval_seconds]
  local interval="${2:-1}"

  # ANSI colors
  local G="\033[32m"       # < 50 ms
  local Y="\033[33m"       # < 100 ms
  local O="\033[38;5;208m" # < 200 ms
  local R="\033[31m"       # >= 200 ms
  local L="\033[90m"       # loss / timeout (gray)
  local RESET="\033[0m"

  ping -i "$interval" "$host" 2>/dev/null |
    awk -v G="$G" -v Y="$Y" -v O="$O" -v R="$R" -v L="$L" -v RESET="$RESET" '
    BEGIN { ok="█"; loss="░"; }
    /bytes from/ {
      # Match "time=12.3 ms" or "time<12.3 ms"
      t=-1
      if ($0 ~ /time=/ || $0 ~ /time</) {
        n=split($0, parts, "time[=<]")
        if (n > 1) {
          sub(/ ms.*/, "", parts[2])
          t = parts[2] + 0
        }
      }
      if (t >= 0) {
        if (t < 50)      printf G ok RESET;
        else if (t < 100) printf Y ok RESET;
        else if (t < 200) printf O ok RESET;
        else               printf R ok RESET;
        fflush();
      }
      next
    }
    /Request timeout|unreachable|Time to live exceeded|packet loss/ {
      printf L loss RESET; fflush(); next
    }
  '
}

alias pgtime="ping --apple-time -i 2 8.8.8.8"

alias spp='spotify_player'

# alias to love
alias love="/Applications/love.app/Contents/MacOS/love"

# script to rename and move downloaed csv files
alias movecsv="~/bin/move_csv.sh"
alias ask="~/bin/ask.sh"
alias since="~/bin/since.sh"

alias pom='~/bin/pomo.py'
alias pomo='~/bin/pomo.py -w $(( $(tput cols) * 80 / 100 ))'
alias tpm='~/bin/tw_pom.sh'

alias gitfold="~/bin/graphfold.py"
alias gitc="~/bin/git_compress.py"
alias list_errors="~/bin/list_erros.py"
alias missdoc="~/bin/list_missing_docstrings.py"
alias list_missing_docstrings="~/bin/list_missing_docstrings.py"
alias logic_map="~/bin/logic_map.py"
alias unused="~/bin/search_unused_files.py"
alias nowp="~/bin/nowplaying.sh"
alias analyze="~/bin/pgn_analyze.py"

alias please="gum input --password | sudo -nS"
alias du10="gum spin --spinner dot --title 'Scanning...' -- fd -t f . --exec du -h {} | sort -rh | head -n 10"
alias wth="curl -s 'wttr.in/{Yeruham,Tel+Aviv,Ein+Hacarmel,Chicago,Baltimore}?format=%l:+%c+%t++⏰+%T\n' | sed 's/.....$//'"

alias vm='vibemark'
graph() {
  local wrap_cols pager_cmd
  wrap_cols=$(( COLUMNS > 10 ? COLUMNS - 10 : 70 ))

  if [[ -n "${PAGER:-}" ]]; then
    pager_cmd="${PAGER}"
  else
    pager_cmd="less -R"
  fi

  git-graph --no-pager --color=always --wrap "$wrap_cols" | eval "$pager_cmd"
}

# more versitle ls/eza version of the eza aliases
function e() {
  if [ -n "$1" ]; then
    eza --sort=modified -r --icons=always | head -"$1"
  else
    eza --sort=modified -r --icons=always
  fi
}

function ez() {
  if [ -n "$1" ]; then
    eza -l --sort=modified -r --icons=always | head -"$1"
  else
    eza -l --sort=modified -r --icons=always
  fi
}

# Simple mkdir-cd combo
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# create and open daily files
todaymd() {
  file="$(date +%Y-%m-%d).md"
  [ ! -f "$file" ] && touch "$file"
  ${EDITOR:-vim} "$file"
}

# My weather commands
function weather() {
  if [ "$1" = "-w" ]; then
    curl "wttr.in/Herzliya?format=3"
  elif [ "$1" = "-h" ]; then
    curl "wttr.in/Yeruham?format=3"
  elif [ -z "$1" ]; then
    curl "wttr.in/?format=3"
  else
    echo "Usage: weather [-w|-h]"
    echo "  -w: Get the weather for Herzliya"
    echo "  -h: Get the weather for Yeruham"
  fi
}

alias weathers="curl -s 'wttr.in/{Yeruham,Tel+Aviv,Ein+Hacarmel,Chicago,Baltimore}?format=%l:+%c+%t++⏰+%T\n' | sed 's/.....$//'"

weathers2() {
  curl -s 'wttr.in/{Yeruham,Tel+Aviv,Ein+Hacarmel,Chicago,Baltimore}?format=%l:+%c+%t++⏰+%T\n' \
  | sed 's/.....$//' \
  | while IFS= read -r line; do
      loc="${line%%:*}"; loc="${loc//+/ }"
      icon="$(awk '{print $2}' <<<"$line")"
      temp="$(awk '{print $3}' <<<"$line")"
      time="$(awk '{print $5}' <<<"$line")"

      tnum="${temp%°C}"; tnum="${tnum#+}"
      if   (( tnum <= 0 ));  then tcol=67
      elif (( tnum <= 10 )); then tcol=109
      elif (( tnum <= 20 )); then tcol=108
      else                        tcol=179
      fi

      loc_p="$(printf '%-18s' "${loc}:")"
      icon_p="$(printf '%-3s'  "$icon")"
      temp_p="$(printf '%6s'   "$temp")"
      time_p="$(printf '%8s'   "$time")"

      printf "%s %s %s  %s %s\n" \
        "$(gum style --foreground 147 "$loc_p")" \
        "$(gum style --foreground 255 "$icon_p")" \
        "$(gum style --foreground "$tcol" "$temp_p")" \
        "$(gum style --faint --foreground 244 "⏰")" \
        "$(gum style --faint --foreground 244 "$time_p")"
    done
}

# Check for too large files
code2heavy() {
  local path threshold exclude

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -p|--path)
        shift
        path="$1"
        ;;
      -t|--threshold)
        shift
        threshold="$1"
        ;;
      -e|--exclude)
        shift
        exclude="$1"
        ;;
      -h|--help)
        echo ""
        echo "code2heavy - Find large files in a directory tree"
        echo ""
        echo "Usage:"
        echo "  code2heavy -p <path> -t <size> [-e <dir>]"
        echo ""
        echo "Options:"
        echo "  -p, --path <path>         Directory to search (required)"
        echo "  -t, --threshold <size>    Minimum file size in megabytes (required)"
        echo "  -e, --exclude <dir>       Exclude directory by name (optional)"
        echo "  -h, --help                Show this help message and exit"
        echo ""
        return 0
        ;;
      *)
        echo "Unknown option: $1"
        return 1
        ;;
    esac
    shift
  done

  if [[ -z "$path" ]]; then
    echo "Please provide a valid path using --path or -p option."
    return 1
  fi

  if [[ -z "$threshold" ]]; then
    echo "Please provide a valid threshold using --threshold or -t option."
    return 1
  fi

  if [[ -z "$exclude" ]]; then
    /usr/bin/find "$path" -type f -size +"$threshold"M
  else
    /usr/bin/find "$path" -type d -name "$exclude" -prune -o -type f -size +"$threshold"M
  fi
}

function record() {
  local default_file="record.log"

  # Check if a command is provided
  if [ -z "$1" ]; then
    echo "No command provided. Usage: run_and_log 'command' [filename]"
    return 1
  fi

  # Get the command to run
  local command="$1"

  # Get the file name if provided, otherwise use the default
  local filename="${2:-$default_file}"

  # Run the command and use tee to write to the file and output to terminal
  eval "$command" | tee "$filename"
}

# A function to use 'mods' to run shell commands
runmods() {
  generated_command=$(mods --role shell "$1")
  echo "Generated command: $generated_command"
  echo "Do you want to (r)un, (c)opy, or (q)uit?"
  read -r action

  case $action in
  r | R)
    # Run the command
    bash -c "$generated_command"
    ;;
  c | C)
    # Copy the command to the clipboard (using pbcopy for MacOS)
    echo "$generated_command" | pbcopy
    echo "Command copied to clipboard."
    ;;
  q | Q)
    echo "Canceled."
    ;;
  *)
    echo "Invalid option. Please enter r, c, or q."
    ;;
  esac
}

modshell() {
  command=$(mods --role shell "$@")
  echo "Generated Command:"
  echo "$command" | gum style --foreground 212 --padding "1 1" --italic

  choice=$(gum choose "Run" "Copy" "Cancel")

  case $choice in
  "Run")
    eval "$command"
    ;;
  "Copy")
    echo "$command" | pbcopy # 'pbcopy' is for macOS
    echo "Command copied to clipboard."
    ;;
  "Cancel")
    echo "Operation canceled."
    ;;
  esac
}

# yazi shell wrapper
function yy() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
	yazi "$@" --cwd-file="$tmp"
	if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		builtin cd -- "$cwd"
	fi
	rm -f -- "$tmp"
}

wav2mp3 () {
  # convert one or many .wav files to VBR MP3 (≈ 192 kbps)
  for file in "$@"; do
    [ -f "$file" ] || { printf '✗ %s: not found\n' "$file"; continue; }
    ffmpeg -i "$file" \
           -codec:a libmp3lame \
           -q:a 2 \
           "${file%.*}.mp3"
  done
}

cheat() {
    curl "https://cheat.sh/$1"
}

pgnget () {
  local n="$1"
  local file="$2"

  if [[ -z "$n" || -z "$file" ]]; then
    print -u2 "Usage: pgnget <game_number> <pgn_file>"
    return 2
  fi
  if [[ ! -f "$file" ]]; then
    print -u2 "pgnget: file not found: $file"
    return 2
  fi
  if [[ "$n" != <-> || "$n" -le 0 ]]; then
    print -u2 "pgnget: game_number must be a positive integer"
    return 2
  fi

  awk -v n="$n" '
    /^\[Event / {g++}
    g==n {print}
    g>n {exit}
  ' "$file"
}

nvim-health() {
  local section="${1:-}"
  nvim --headless \
    +"checkhealth ${section}" \
    +"lua for _,b in ipairs(vim.api.nvim_list_bufs()) do local n=vim.api.nvim_buf_get_name(b); if n:match('^health://') then for _,l in ipairs(vim.api.nvim_buf_get_lines(b,0,-1,false)) do print(l) end; break end end" \
    +qall 2>&1
}

topcmds () {
  local n="${1:-20}"
  fc -ln 1 \
  | sed -E 's/^[[:space:]]*//' \
  | awk 'NF{
    cmd=$1
    if (cmd=="sudo") cmd=$2
    a[cmd]++
  } END{
    for (c in a) printf "%d\t%s\n", a[c], c
  }' \
  | sort -nr | head -n "$n" \
  | gum table -p -s $'\t' -c Count -c Command \
}

export FZF_CTRL_R_OPTS=$'
  --no-multi-line
  # only 5 lines height
  --height=15
  --layout=reverse
  --border=rounded
  --info=inline-right
  --prompt="󰋚 history ❯ "
  --pointer="▶ "
  --marker="󰄬 "
  --header="enter: paste • ctrl-/: preview • esc: cancel"
  --bind=ctrl-/:toggle-preview,alt-/:toggle-wrap
  --preview-window=down:80%:wrap:hidden
  --preview=\'echo {} | bat --language=bash --style=plain --color=always\'
'

alias ai=modshell
